<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Recettes</title>
    <meta name="description" content="Gestionnaire de recettes avec s√©lection al√©atoire et g√©n√©ration automatique de listes de courses">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçΩÔ∏è</text></svg>">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-online {
            background: #27ae60;
            color: white;
        }

        .status-offline {
            background: #e74c3c;
            color: white;
        }

        .nav {
            background: #ecf0f1;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .nav button {
            background: none;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav button:hover {
            background: #d5dbdb;
        }

        .nav button.active {
            background: white;
            border-bottom-color: #3498db;
            color: #3498db;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .recipe-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            transition: transform 0.3s;
        }

        .recipe-card:hover {
            transform: translateX(5px);
        }

        .recipe-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .recipe-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .ingredients-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .ingredient-item {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .random-selection {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .shopping-list {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .shopping-item {
            padding: 10px;
            border-bottom: 1px solid #c8e6c9;
            display: flex;
            justify-content: space-between;
        }

        .shopping-item:last-child {
            border-bottom: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .number-input {
            width: 100px;
            display: inline-block;
            margin-right: 10px;
        }

        .selected-recipes {
            margin-top: 20px;
        }

        .selected-recipe {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .migration-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .config-section {
            background: #d1ecf1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }
            
            .recipe-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="connection-status" class="connection-status status-offline">‚ö™ D√©connect√©</div>
            <h1>üçΩÔ∏è Gestionnaire de Recettes</h1>
            <p>G√©rez vos recettes avec synchronisation cloud via Supabase</p>
        </div>

        <div class="nav">
            <button class="nav-btn active" data-section="config">Configuration</button>
            <button class="nav-btn" data-section="recipes">Mes Recettes</button>
            <button class="nav-btn" data-section="add-recipe">Ajouter Recette</button>
            <button class="nav-btn" data-section="random">S√©lection Al√©atoire</button>
            <button class="nav-btn" data-section="shopping">Liste de Courses</button>
            <button class="nav-btn" data-section="migration">Migration</button>
        </div>

        <div class="content">
            <!-- Section Configuration -->
            <div id="config" class="section active">
                <h2>Configuration Supabase</h2>
                <div class="config-section">
                    <p><strong>Instructions :</strong></p>
                    <ol>
                        <li>Cr√©ez un compte sur <a href="https://supabase.com" target="_blank">supabase.com</a></li>
                        <li>Cr√©ez un nouveau projet</li>
                        <li>Allez dans Settings ‚Üí API</li>
                        <li>Copiez votre URL et cl√© API ci-dessous</li>
                        <li>Ex√©cutez le script SQL fourni dans SQL Editor</li>
                    </ol>
                </div>

                <div class="form-group">
                    <label for="supabase-url">URL Supabase *</label>
                    <input type="url" id="supabase-url" placeholder="https://xxxxxx.supabase.co">
                </div>

                <div class="form-group">
                    <label for="supabase-key">Cl√© API (anon/public) *</label>
                    <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6...">
                </div>

                <button id="test-connection" class="btn-success">Tester la connexion</button>
                <button id="save-config" class="btn-success">Sauvegarder la configuration</button>

                <div id="connection-result"></div>
            </div>

            <!-- Section Migration -->
            <div id="migration" class="section">
                <h2>Migration des donn√©es</h2>
                <div class="migration-section">
                    <h3>üì¶ Migration localStorage ‚Üí Supabase</h3>
                    <p>Transf√©rez vos recettes stock√©es localement vers Supabase pour la synchronisation cloud.</p>
                    
                    <div id="migration-status"></div>
                    
                    <button id="check-local-data">V√©rifier les donn√©es locales</button>
                    <button id="migrate-data" class="btn-success" disabled>Migrer vers Supabase</button>
                    <button id="clear-local-data" class="btn-danger" disabled>Vider localStorage</button>
                </div>
            </div>

            <!-- Section Mes Recettes -->
            <div id="recipes" class="section">
                <h2>Mes Recettes</h2>
                <button id="refresh-recipes" class="btn-success">üîÑ Actualiser</button>
                <div id="recipes-list"></div>
                <div id="no-recipes" class="alert alert-info" style="display: none;">
                    <strong>Aucune recette trouv√©e.</strong> Commencez par ajouter quelques recettes !
                </div>
                <div id="recipes-loading" class="loading" style="display: none;">
                    <strong>Chargement des recettes...</strong>
                </div>
            </div>

            <!-- Section Ajouter Recette -->
            <div id="add-recipe" class="section">
                <h2>Ajouter une Nouvelle Recette</h2>
                <form id="recipe-form">
                    <div class="form-group">
                        <label for="recipe-name">Nom de la recette *</label>
                        <input type="text" id="recipe-name" required>
                    </div>

                    <div class="form-group">
                        <label for="recipe-portions">Nombre de portions *</label>
                        <input type="number" id="recipe-portions" min="1" value="4" required>
                    </div>

                    <div class="form-group">
                        <label for="recipe-type">Type de recette *</label>
                        <select id="recipe-type" required>
                            <option value="">S√©lectionnez un type</option>
                            <option value="plat">Plat</option>
                            <option value="entr√©e">Entr√©e</option>
                            <option value="dessert">Dessert</option>
                            <option value="accompagnement">Accompagnement</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="recipe-link">Lien (optionnel)</label>
                        <input type="url" id="recipe-link" placeholder="https://...">
                    </div>

                    <h3>Ingr√©dients</h3>
                    <div id="ingredients-container">
                        <div class="ingredient-row">
                            <div class="form-group">
                                <label>Ingr√©dient *</label>
                                <input type="text" class="ingredient-name" required>
                            </div>
                            <div class="form-group">
                                <label>Quantit√© *</label>
                                <input type="number" class="ingredient-quantity" step="0.1" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Unit√© *</label>
                                <select class="ingredient-unit" required>
                                    <option value="">S√©lectionnez</option>
                                    <option value="g">grammes</option>
                                    <option value="kg">kilogrammes</option>
                                    <option value="ml">millilitres</option>
                                    <option value="l">litres</option>
                                    <option value="pi√®ce">pi√®ce(s)</option>
                                    <option value="cuill√®re √† soupe">cuill√®re(s) √† soupe</option>
                                    <option value="cuill√®re √† caf√©">cuill√®re(s) √† caf√©</option>
                                    <option value="tasse">tasse(s)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button type="button" id="add-ingredient">Ajouter un ingr√©dient</button>
                    <button type="submit" id="save-recipe" class="btn-success">Enregistrer la recette</button>
                </form>
            </div>

            <!-- Section S√©lection Al√©atoire -->
            <div id="random" class="section">
                <h2>S√©lection Al√©atoire de Recettes</h2>
                <div class="random-selection">
                    <label for="num-recipes">Nombre de recettes √† s√©lectionner :</label>
                    <input type="number" id="num-recipes" class="number-input" min="1" value="5">
                    <button id="generate-random" class="btn-success">G√©n√©rer une s√©lection al√©atoire</button>
                </div>

                <div id="selected-recipes-container" class="selected-recipes"></div>
            </div>

            <!-- Section Liste de Courses -->
            <div id="shopping" class="section">
                <h2>Liste de Courses</h2>
                <p>Bas√©e sur les recettes s√©lectionn√©es dans la section "S√©lection Al√©atoire"</p>
                <button id="generate-shopping">G√©n√©rer la liste de courses</button>
                <div id="shopping-list-container"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration et client Supabase
        let supabaseClient = null;
        let isConnected = false;

        // Gestion des donn√©es
        class RecipeManagerSupabase {
            constructor() {
                this.recipes = [];
                this.selectedRecipes = [];
                this.loadConfig();
            }

            // Configuration Supabase
            loadConfig() {
                const url = localStorage.getItem('supabase_url');
                const key = localStorage.getItem('supabase_key');
                
                if (url && key) {
                    document.getElementById('supabase-url').value = url;
                    document.getElementById('supabase-key').value = key;
                    this.initSupabase(url, key);
                }
            }

            saveConfig(url, key) {
                localStorage.setItem('supabase_url', url);
                localStorage.setItem('supabase_key', key);
            }

            initSupabase(url, key) {
                try {
                    supabaseClient = supabase.createClient(url, key);
                    this.testConnection();
                } catch (error) {
                    this.updateConnectionStatus(false, 'Erreur de configuration');
                }
            }

            async testConnection() {
                if (!supabaseClient) {
                    this.updateConnectionStatus(false, 'Client non initialis√©');
                    return false;
                }

                try {
                    const { data, error } = await supabaseClient
                        .from('recipes')
                        .select('count', { count: 'exact', head: true });

                    if (error) {
                        this.updateConnectionStatus(false, `Erreur DB: ${error.message}`);
                        return false;
                    }

                    this.updateConnectionStatus(true, 'Connexion r√©ussie');
                    return true;
                } catch (error) {
                    this.updateConnectionStatus(false, `Erreur r√©seau: ${error.message}`);
                    return false;
                }
            }

            updateConnectionStatus(connected, message = '') {
                isConnected = connected;
                const statusEl = document.getElementById('connection-status');
                const resultEl = document.getElementById('connection-result');
                
                if (connected) {
                    statusEl.className = 'connection-status status-online';
                    statusEl.textContent = 'üü¢ Connect√©';
                    if (resultEl) {
                        resultEl.innerHTML = '<div class="alert alert-info">‚úÖ Connexion Supabase r√©ussie !</div>';
                    }
                } else {
                    statusEl.className = 'connection-status status-offline';
                    statusEl.textContent = 'üî¥ D√©connect√©';
                    if (resultEl) {
                        resultEl.innerHTML = `<div class="alert alert-error">‚ùå ${message}</div>`;
                    }
                }
            }

            // CRUD Recettes
            async loadRecipes() {
                if (!supabaseClient || !isConnected) {
                    throw new Error('Supabase non configur√© ou d√©connect√©');
                }

                const { data, error } = await supabaseClient
                    .from('recipes')
                    .select(`
                        *,
                        ingredients (*)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                this.recipes = data || [];
                return this.recipes;
            }

            async addRecipe(recipe) {
                if (!supabaseClient || !isConnected) {
                    throw new Error('Supabase non configur√©');
                }

                // Ins√©rer la recette
                const { data: recipeData, error: recipeError } = await supabaseClient
                    .from('recipes')
                    .insert([{
                        name: recipe.name,
                        portions: recipe.portions,
                        type: recipe.type,
                        link: recipe.link || null
                    }])
                    .select()
                    .single();

                if (recipeError) throw recipeError;

                // Ins√©rer les ingr√©dients
                const ingredients = recipe.ingredients.map(ing => ({
                    recipe_id: recipeData.id,
                    name: ing.name,
                    quantity: ing.quantity,
                    unit: ing.unit
                }));

                const { error: ingredientsError } = await supabaseClient
                    .from('ingredients')
                    .insert(ingredients);

                if (ingredientsError) throw ingredientsError;

                return recipeData;
            }

            async deleteRecipe(id) {
                if (!supabaseClient || !isConnected) {
                    throw new Error('Supabase non configur√©');
                }

                // Les ingr√©dients seront supprim√©s automatiquement (CASCADE)
                const { error } = await supabaseClient
                    .from('recipes')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
            }

            getRecipesByType(type) {
                return this.recipes.filter(recipe => recipe.type === type);
            }

            getRandomRecipes(count, type = 'plat') {
                const availableRecipes = this.getRecipesByType(type);
                if (availableRecipes.length === 0) return [];
                
                const shuffled = [...availableRecipes].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, Math.min(count, availableRecipes.length));
            }

            generateShoppingList() {
                const shoppingMap = new Map();

                this.selectedRecipes.forEach(selection => {
                    const recipe = this.recipes.find(r => r.id === selection.recipeId);
                    if (!recipe) return;

                    const multiplier = selection.portions / recipe.portions;

                    recipe.ingredients.forEach(ingredient => {
                        const key = `${ingredient.name}_${ingredient.unit}`;
                        const adjustedQuantity = ingredient.quantity * multiplier;

                        if (shoppingMap.has(key)) {
                            shoppingMap.set(key, {
                                name: ingredient.name,
                                quantity: shoppingMap.get(key).quantity + adjustedQuantity,
                                unit: ingredient.unit
                            });
                        } else {
                            shoppingMap.set(key, {
                                name: ingredient.name,
                                quantity: adjustedQuantity,
                                unit: ingredient.unit
                            });
                        }
                    });
                });

                return Array.from(shoppingMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            }

            // Migration depuis localStorage
            getLocalStorageRecipes() {
                const stored = localStorage.getItem('recipes');
                return stored ? JSON.parse(stored) : [];
            }

            async migrateFromLocalStorage() {
                const localRecipes = this.getLocalStorageRecipes();
                if (localRecipes.length === 0) {
                    throw new Error('Aucune recette trouv√©e dans localStorage');
                }

                const results = [];
                for (const recipe of localRecipes) {
                    try {
                        const migrated = await this.addRecipe(recipe);
                        results.push({ success: true, name: recipe.name, id: migrated.id });
                    } catch (error) {
                        results.push({ success: false, name: recipe.name, error: error.message });
                    }
                }

                return results;
            }

            clearLocalStorage() {
                localStorage.removeItem('recipes');
            }
        }

        // Instance globale
        const recipeManager = new RecipeManagerSupabase();

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            setupNavigation();
            setupConfiguration();
            setupMigration();
            setupRecipeManagement();
            setupRandomSelection();
            setupShoppingList();
        });

        // Gestion de la navigation
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.section');

            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.dataset.section;
                    
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetSection).classList.add('active');
                    
                    // Actions sp√©cifiques selon la section
                    if (targetSection === 'recipes') {
                        displayRecipes();
                    }
                });
            });
        }

        // Configuration Supabase
        function setupConfiguration() {
            const testBtn = document.getElementById('test-connection');
            const saveBtn = document.getElementById('save-config');

            testBtn.addEventListener('click', async function() {
                const url = document.getElementById('supabase-url').value;
                const key = document.getElementById('supabase-key').value;

                if (!url || !key) {
                    document.getElementById('connection-result').innerHTML = 
                        '<div class="alert alert-error">Veuillez remplir tous les champs</div>';
                    return;
                }

                this.disabled = true;
                this.textContent = 'Test en cours...';

                recipeManager.initSupabase(url, key);
                
                // Attendre un peu pour le test
                setTimeout(() => {
                    this.disabled = false;
                    this.textContent = 'Tester la connexion';
                }, 2000);
            });

            saveBtn.addEventListener('click', function() {
                const url = document.getElementById('supabase-url').value;
                const key = document.getElementById('supabase-key').value;

                if (!url || !key) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }

                recipeManager.saveConfig(url, key);
                alert('Configuration sauvegard√©e !');
            });
        }

        // Gestion de la migration
        function setupMigration() {
            const checkBtn = document.getElementById('check-local-data');
            const migrateBtn = document.getElementById('migrate-data');
            const clearBtn = document.getElementById('clear-local-data');
            const statusEl = document.getElementById('migration-status');

            checkBtn.addEventListener('click', function() {
                const localRecipes = recipeManager.getLocalStorageRecipes();
                
                if (localRecipes.length === 0) {
                    statusEl.innerHTML = '<div class="alert alert-info">Aucune recette trouv√©e dans localStorage</div>';
                    migrateBtn.disabled = true;
                    clearBtn.disabled = true;
                } else {
                    statusEl.innerHTML = `
                        <div class="alert alert-info">
                            <strong>${localRecipes.length} recette(s) trouv√©e(s) dans localStorage :</strong>
                            <ul style="margin-top: 10px;">
                                ${localRecipes.map(r => `<li>${r.name} (${r.ingredients?.length || 0} ingr√©dients)</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    migrateBtn.disabled = false;
                    clearBtn.disabled = false;
                }
            });

            migrateBtn.addEventListener('click', async function() {
                if (!isConnected) {
                    statusEl.innerHTML = '<div class="alert alert-error">Veuillez d\'abord configurer et tester Supabase</div>';
                    return;
                }

                this.disabled = true;
                this.textContent = 'Migration en cours...';

                try {
                    const results = await recipeManager.migrateFromLocalStorage();
                    const successes = results.filter(r => r.success);
                    const failures = results.filter(r => !r.success);

                    let html = `<div class="alert alert-info">
                        <strong>Migration termin√©e !</strong><br>
                        ‚úÖ ${successes.length} recette(s) migr√©e(s) avec succ√®s
                    `;

                    if (failures.length > 0) {
                        html += `<br>‚ùå ${failures.length} √©chec(s) :
                            <ul>${failures.map(f => `<li>${f.name}: ${f.error}</li>`).join('')}</ul>
                        `;
                    }

                    html += '</div>';
                    statusEl.innerHTML = html;

                    if (successes.length > 0) {
                        clearBtn.disabled = false;
                    }

                } catch (error) {
                    statusEl.innerHTML = `<div class="alert alert-error">Erreur: ${error.message}</div>`;
                } finally {
                    this.disabled = false;
                    this.textContent = 'Migrer vers Supabase';
                }
            });

            clearBtn.addEventListener('click', function() {
                if (confirm('√ätes-vous s√ªr de vouloir supprimer les donn√©es localStorage ? Cette action est irr√©versible.')) {
                    recipeManager.clearLocalStorage();
                    statusEl.innerHTML = '<div class="alert alert-info">Donn√©es localStorage supprim√©es</div>';
                    this.disabled = true;
                    migrateBtn.disabled = true;
                }
            });
        }

        // Gestion des recettes
        function setupRecipeManagement() {
            // Bouton d'actualisation
            document.getElementById('refresh-recipes').addEventListener('click', displayRecipes);

            // Formulaire d'ajout de recette
            setupRecipeForm();
        }

        // Affichage des recettes
        async function displayRecipes() {
            const container = document.getElementById('recipes-list');
            const noRecipesMsg = document.getElementById('no-recipes');
            const loadingMsg = document.getElementById('recipes-loading');

            if (!isConnected) {
                container.innerHTML = '<div class="alert alert-warning">Veuillez configurer Supabase pour voir vos recettes</div>';
                noRecipesMsg.style.display = 'none';
                return;
            }

            // Afficher le loading
            container.innerHTML = '';
            noRecipesMsg.style.display = 'none';
            loadingMsg.style.display = 'block';

            try {
                await recipeManager.loadRecipes();

                if (recipeManager.recipes.length === 0) {
                    noRecipesMsg.style.display = 'block';
                    container.innerHTML = '';
                } else {
                    noRecipesMsg.style.display = 'none';
                    container.innerHTML = recipeManager.recipes.map(recipe => `
                        <div class="recipe-card">
                            <div class="recipe-title">${recipe.name}</div>
                            <div class="recipe-meta">
                                <span><strong>Type:</strong> ${recipe.type}</span>
                                <span><strong>Portions:</strong> ${recipe.portions}</span>
                                <span><strong>Ajout√©:</strong> ${new Date(recipe.created_at).toLocaleDateString('fr-FR')}</span>
                                ${recipe.link ? `<span><a href="${recipe.link}" target="_blank">Voir la recette</a></span>` : ''}
                            </div>
                            <div class="ingredients-list">
                                <strong>Ingr√©dients:</strong>
                                ${recipe.ingredients.map(ing => `
                                    <div class="ingredient-item">
                                        <span>${ing.name}</span>
                                        <span>${ing.quantity} ${ing.unit}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="deleteRecipe(${recipe.id})" class="btn-danger">Supprimer</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Erreur: ${error.message}</div>`;
                noRecipesMsg.style.display = 'none';
            } finally {
                loadingMsg.style.display = 'none';
            }
        }

        // Configuration du formulaire d'ajout de recette
        function setupRecipeForm() {
            const form = document.getElementById('recipe-form');
            const addIngredientBtn = document.getElementById('add-ingredient');
            const container = document.getElementById('ingredients-container');

            addIngredientBtn.addEventListener('click', function() {
                addIngredientRow(container);
            });

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!isConnected) {
                    alert('Veuillez configurer Supabase avant d\'ajouter une recette');
                    return;
                }

                const saveBtn = document.getElementById('save-recipe');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Enregistrement...';

                try {
                    const recipe = {
                        name: document.getElementById('recipe-name').value,
                        portions: parseInt(document.getElementById('recipe-portions').value),
                        type: document.getElementById('recipe-type').value,
                        link: document.getElementById('recipe-link').value,
                        ingredients: []
                    };

                    // Collecte des ingr√©dients
                    const ingredientRows = container.querySelectorAll('.ingredient-row');
                    ingredientRows.forEach(row => {
                        const name = row.querySelector('.ingredient-name').value;
                        const quantity = parseFloat(row.querySelector('.ingredient-quantity').value);
                        const unit = row.querySelector('.ingredient-unit').value;

                        if (name && quantity && unit) {
                            recipe.ingredients.push({ name, quantity, unit });
                        }
                    });

                    if (recipe.ingredients.length === 0) {
                        alert('Veuillez ajouter au moins un ingr√©dient.');
                        return;
                    }

                    await recipeManager.addRecipe(recipe);
                    
                    // R√©initialiser le formulaire
                    form.reset();
                    resetIngredientsContainer();
                    
                    alert('Recette ajout√©e avec succ√®s !');

                } catch (error) {
                    alert(`Erreur: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Enregistrer la recette';
                }
            });
        }

        function addIngredientRow(container) {
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'ingredient-row';
            ingredientRow.innerHTML = `
                <div class="form-group">
                    <label>Ingr√©dient *</label>
                    <input type="text" class="ingredient-name" required>
                </div>
                <div class="form-group">
                    <label>Quantit√© *</label>
                    <input type="number" class="ingredient-quantity" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label>Unit√© *</label>
                    <select class="ingredient-unit" required>
                        <option value="">S√©lectionnez</option>
                        <option value="g">grammes</option>
                        <option value="kg">kilogrammes</option>
                        <option value="ml">millilitres</option>
                        <option value="l">litres</option>
                        <option value="pi√®ce">pi√®ce(s)</option>
                        <option value="cuill√®re √† soupe">cuill√®re(s) √† soupe</option>
                        <option value="cuill√®re √† caf√©">cuill√®re(s) √† caf√©</option>
                        <option value="tasse">tasse(s)</option>
                    </select>
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="btn-danger">Supprimer</button>
            `;
            container.appendChild(ingredientRow);
        }

        function resetIngredientsContainer() {
            const container = document.getElementById('ingredients-container');
            container.innerHTML = `
                <div class="ingredient-row">
                    <div class="form-group">
                        <label>Ingr√©dient *</label>
                        <input type="text" class="ingredient-name" required>
                    </div>
                    <div class="form-group">
                        <label>Quantit√© *</label>
                        <input type="number" class="ingredient-quantity" step="0.1" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Unit√© *</label>
                        <select class="ingredient-unit" required>
                            <option value="">S√©lectionnez</option>
                            <option value="g">grammes</option>
                            <option value="kg">kilogrammes</option>
                            <option value="ml">millilitres</option>
                            <option value="l">litres</option>
                            <option value="pi√®ce">pi√®ce(s)</option>
                            <option value="cuill√®re √† soupe">cuill√®re(s) √† soupe</option>
                            <option value="cuill√®re √† caf√©">cuill√®re(s) √† caf√©</option>
                            <option value="tasse">tasse(s)</option>
                        </select>
                    </div>
                </div>
            `;
        }

        // Configuration de la s√©lection al√©atoire
        function setupRandomSelection() {
            const generateBtn = document.getElementById('generate-random');
            const container = document.getElementById('selected-recipes-container');

            generateBtn.addEventListener('click', function() {
                if (!isConnected || recipeManager.recipes.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning">Veuillez d\'abord charger vos recettes</div>';
                    return;
                }

                const numRecipes = parseInt(document.getElementById('num-recipes').value);
                if (!numRecipes || numRecipes < 1) {
                    alert('Veuillez entrer un nombre valide de recettes.');
                    return;
                }

                const randomRecipes = recipeManager.getRandomRecipes(numRecipes, 'plat');
                if (randomRecipes.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning">Aucune recette de type "plat" trouv√©e.</div>';
                    return;
                }

                recipeManager.selectedRecipes = randomRecipes.map(recipe => ({
                    recipeId: recipe.id,
                    portions: recipe.portions
                }));

                container.innerHTML = `
                    <h3>Recettes s√©lectionn√©es :</h3>
                    ${randomRecipes.map(recipe => `
                        <div class="selected-recipe">
                            <div>
                                <strong>${recipe.name}</strong>
                                <div style="font-size: 14px; color: #666;">
                                    ${recipe.ingredients.length} ingr√©dients ‚Ä¢ ${recipe.type}
                                </div>
                            </div>
                            <div>
                                <label style="margin-right: 10px;">Portions:</label>
                                <input type="number" min="1" value="${recipe.portions}" 
                                       onchange="updateRecipePortions(${recipe.id}, this.value)"
                                       style="width: 60px;">
                            </div>
                        </div>
                    `).join('')}
                `;
            });
        }

        // Configuration de la liste de courses
        function setupShoppingList() {
            const generateBtn = document.getElementById('generate-shopping');
            const container = document.getElementById('shopping-list-container');

            generateBtn.addEventListener('click', function() {
                if (!isConnected) {
                    container.innerHTML = '<div class="alert alert-warning">Veuillez configurer Supabase</div>';
                    return;
                }

                if (recipeManager.selectedRecipes.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning">Veuillez d\'abord s√©lectionner des recettes dans la section "S√©lection Al√©atoire".</div>';
                    return;
                }

                const shoppingList = recipeManager.generateShoppingList();
                
                container.innerHTML = `
                    <div class="shopping-list">
                        <h3>üõí Liste de Courses</h3>
                        <p><small>Bas√©e sur ${recipeManager.selectedRecipes.length} recette(s) s√©lectionn√©e(s)</small></p>
                        ${shoppingList.map(item => `
                            <div class="shopping-item">
                                <span>${item.name}</span>
                                <strong>${Math.round(item.quantity * 100) / 100} ${item.unit}</strong>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
        }

        // Fonctions utilitaires globales
        async function deleteRecipe(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette recette ?')) {
                return;
            }

            try {
                await recipeManager.deleteRecipe(id);
                displayRecipes(); // Rafra√Æchir la liste
                alert('Recette supprim√©e avec succ√®s');
            } catch (error) {
                alert(`Erreur: ${error.message}`);
            }
        }

        function updateRecipePortions(recipeId, newPortions) {
            const selection = recipeManager.selectedRecipes.find(s => s.recipeId === recipeId);
            if (selection) {
                selection.portions = parseInt(newPortions);
            }
        }
    </script>
</body>
</html>
